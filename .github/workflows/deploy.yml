name: 🚀 Deploy to Production

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    name: 🌍 Deploy Applications
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: 📦 Checkout code
        uses: actions/checkout@v4

      - name: 🔧 Setup Docker Context
        run: |
          echo "Setting up deployment for ${{ github.event.inputs.environment || 'production' }}"

      # Exemple de déploiement avec docker-compose
      - name: 📋 Create production docker-compose
        run: |
          cat > docker-compose.prod.yml << EOF
          version: '3.8'
          services:
            api:
              image: ghcr.io/${{ github.repository }}-backend:latest
              container_name: shop-api-prod
              ports:
                - "3000:3000"
              environment:
                - DATABASE_URL=file:./data/prod.db
                - JWT_SECRET=${{ secrets.JWT_SECRET_PROD }}
                - DEFAULT_ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD_PROD }}
                - BCRYPT_SALT_ROUNDS=12
                - NODE_ENV=production
              volumes:
                - api_data:/app/data
              restart: unless-stopped
                
            frontend:
              image: ghcr.io/${{ github.repository }}-frontend:latest
              container_name: shop-frontend-prod
              ports:
                - "80:80"
              depends_on:
                - api
              restart: unless-stopped
              
          volumes:
            api_data:
          EOF

      - name: 📦 Save production compose
        uses: actions/upload-artifact@v4
        with:
          name: docker-compose-production
          path: docker-compose.prod.yml

      # Ici tu pourrais ajouter le déploiement réel vers ton serveur
      # Par exemple avec SSH, AWS, DigitalOcean, etc.

      - name: 📝 Deployment summary
        run: |
          echo "## 🚀 Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Image**: ghcr.io/${{ github.repository }}-backend:latest" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend Image**: ghcr.io/${{ github.repository }}-frontend:latest" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
